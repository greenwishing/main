# 多人在线点菜

## 1. 入口：

进入方式有两种：

1. 微信扫码进入，此时已经确定 **桌台**，可直接多人点菜；

2. 从分享的链接进入，链接不带有桌台信息，在下单前需要重新扫码以确定桌台。


## 2. 点菜

如果已经确定桌台，则需要定时异步从后台取当前台中其它人点的菜品，并显示到自己的购物车中，用其它颜色（待定）标记出来；

在修改菜品数量时，需要更新购物车明细的 **更新时间**

```
购物车需要添加“桌台号”、 “状态” （正常、已下单）等信息;
购物车明细需要添加“更新时间”
```


## 3. 下单

同时满足以下两个条件才能下单：

1. 下单时提交的购物车 **数量** 与数据库中查询的 **数量** 一致

2. 同桌台有任何 **购物车明细** 的 **更新时间** 大于 **当前时间** ，提示用户“ *购物车的菜品被同桌修改过，请确认！*”，然后刷新购物车

下单成功后跳转至 **已下单菜单** 页面


## 4. 已下单菜单

该页面需要 **实时异步** 向后台检查当前桌台 **已提交的线上订单** 及 **已确认的线下账单** 的状态变化，如果有变化则需要提示用户“ *订单状态有新的变化，请刷新！* ”

状态变化主要有以下几点：

1. **超时未确认**：如果订单经过一定时间（待定）未处理，`后台任务` 将此单状态标记为 **下单失败**

2. **店家已确认**：对于店家已经处理订单， “线下”通过订单接口将状态改为 **已处理**

3. **账单已支付**：对于已经支付的账单，状态改为 **已支付**

```
“线下” 主要包括 “云POS” 及 “迅手”
对于下单失败的订单，用户可选择 “重新提交” 或 “删除” 此订单
```


## 5. 发起支付

当店家确认订单后，同桌的任何一个用户可对该账单 **发起支付** 

1. 当用户成功发起支付时，将此账单状态改为 **支付中** 

2. 账单状态为 **支付中** 其它人再发起支付时，提示“ *XXX正在支付了！* ”

```
需要将成功发起支付的用户的open_id存入账单中，其它人再支付时，就可提示是谁正在支付
```
